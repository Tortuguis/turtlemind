(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[61051],{39134:()=>{},18952:(e,t,a)=>{"use strict";a.d(t,{T:()=>function e(t,a){return a?Array.isArray(a)?a.map(a=>e(t,a)):"object"==typeof a?Object.keys(a).reduce((n,s)=>{let r=a[s];return n["client"===t?i.snakeToCamel(s):i.camelToSnake(s)]=e(t,r),n},{}):a:a}});let i={snakeToCamel:e=>e.replace(/(_[a-z])/g,e=>e.toUpperCase().replace("_","")),camelToSnake:e=>e.replace(/([A-Z])/g,e=>"_".concat(e.toLowerCase())).replace(/^_/,"")}},58220:(e,t,a)=>{"use strict";a.d(t,{qc:()=>h,X7:()=>I,Om:()=>A});var i=a(23693),n=a(76656),s=a(45571);let r=function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a]},o="NEW_SESSION_EVENT",c=(e,t)=>{let a=new Map;for(let i of e){let e=t(i);a.has(e)||a.set(e,i)}return Array.from(a.values())},l="sessions",u="sessionEvents",d="metadata",w="session-list",p=null,f=15,m=async()=>(p||(p=await (0,s.P2)("session-cache",1,{upgrade(e){e.createObjectStore(l,{keyPath:"id"}),e.createObjectStore(u,{keyPath:"id"}).createIndex("by-session","sessionId"),e.createObjectStore(d).put({sessionIds:[]},w)}})),p);async function v(e){r("updateAccessTime",e);let t=(await m()).transaction([d],"readwrite"),a=t.objectStore(d),i=await a.get(w)||{sessionIds:[]};i.sessionIds=i.sessionIds.filter(t=>t!==e),i.sessionIds.unshift(e),await a.put(i,w),await t.done}async function y(){let e=(await m()).transaction([l,d,u],"readwrite"),t=e.objectStore(d),a=await t.get(w);if(a&&a.sessionIds.length>f){let i=a.sessionIds.slice(f),n=e.objectStore(l);r("remove",i),await Promise.all(i.map(async t=>{let a=e.objectStore(u).index("by-session"),i=await a.openCursor(t);for(;i;)await i.delete(),i=await i.continue();return n.delete(t)})),a.sessionIds=a.sessionIds.slice(0,f),await t.put(a,w)}await e.done}async function S(e){let t=await m(),a=await t.getAllFromIndex(u,"by-session",e);return r("getSessionEvents",e,a.length),a}let g={configure(e){e.maxSessions&&(f=e.maxSessions,y().catch(console.error))},async get(e){let t=await m(),a=await t.get(l,e);if(!a)return null;let i=await S(e);return await v(e),{...a,events:i,s3UrlExpireAt:a.s3UrlsExpiredAt||0}},async updateSession(e){var t;let a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=await m(),{events:n,...s}=e,r=i.transaction([l,u],"readwrite"),o=await r.objectStore(l).get(e.id),c=[...e.events].sort((e,t)=>e.timestamp-t.timestamp);await r.objectStore(l).put({...s,lastEventId:null===(t=c[c.length-1])||void 0===t?void 0:t.id,s3UrlsExpiredAt:a?Date.now()+432e6:null==o?void 0:o.s3UrlsExpiredAt}),await Promise.all(c.map(t=>r.objectStore(u).put({...t,sessionId:e.id}))),await r.done,await v(e.id),await y()},async pushConfirmedEvents(e,t,a){let i=(await m()).transaction([l,u],"readwrite"),s=i.objectStore(l),d=await s.get(e),w=i.objectStore(u).index("by-session"),p=await w.getAll(e);if(d){if(!p.find(e=>e.id===a)&&a!==o){await i.done;return}let n=new Set(p.map(e=>e.id)),c=null,l=t.filter(e=>!n.has(e.id));for(let e of l)c?e.timestamp>c.timestamp&&(c=e):c=e;r("append events",d.id,l.length),await Promise.all(l.map(async t=>await i.objectStore(u).put({...t,sessionId:e}))),c&&(d.lastEventId=c.id),await s.put(d)}else{var f;let a=c(t,e=>e.id).sort((e,t)=>e.timestamp-t.timestamp);await s.put({id:e,title:"",lastEventId:null===(f=a[a.length-1])||void 0===f?void 0:f.id,agentTaskMode:n.Ku.UNSPECIFIED}),await Promise.all(a.map(t=>i.objectStore(u).put({...t,sessionId:e})))}await i.done,await v(e),await y()},async updateMeta(e,t){let a=(await m()).transaction(l,"readwrite"),i=a.objectStore(l),s=await i.get(e);s?(void 0!==t.title&&(s.title=t.title),void 0!==t.iconInfo&&(s.iconInfo=t.iconInfo),await i.put(s)):await i.put({id:e,title:t.title||"",iconInfo:t.iconInfo,agentTaskMode:n.Ku.UNSPECIFIED}),await a.done,await v(e),await y()},async clear(){let e=await m();await e.clear(l),await e.clear(u),await e.put(d,{sessionIds:[]},w)},async removeId(e){let t=(await m()).transaction([l,d,u],"readwrite");await t.objectStore(l).delete(e);let a=t.objectStore(u).index("by-session"),i=await a.openCursor(e);for(;i;)await i.delete(),i=await i.continue();let n=t.objectStore(d),s=await n.get(w);s&&(s.sessionIds=s.sessionIds.filter(t=>t!==e),await n.put(s,w)),await t.done},async getLastEventId(e){let t=await m(),a=await t.get(l,e);return(null==a?void 0:a.lastEventId)||null}},h=async()=>g.clear();async function I(e,t){let a=async()=>{let a=await e(i.R.endpoints.getSession.initiate({sessionId:t,type:"private"},{forceRefetch:!0})).unwrap();return await g.updateSession(a,!0),a},s=await g.get(t);if(s){let e=s.s3UrlExpireAt-Date.now();if(s.agentTaskMode===n.Ku.UNSPECIFIED)a();else{if(e<0)return await a();e<216e6&&a()}return s}return await a()}let b=[],_=null,E=null,U=null,A={receiveNewEvent:async function(e,t,a){if(_!==t&&(_=t,b=[],U=null),E!==e&&(E=e,U=null,b=[]),"eventsNotifyEventsAfter"===a.type){U=a.eventId,await g.pushConfirmedEvents(e,[...b,...a.events],a.eventId),b=[];return}if("chatDelta"!==a.type){if(U){await g.pushConfirmedEvents(e,[...b,a],U),b=[];return}b.push(a)}},joinNewSession:async function(e,t){E!==e&&(E=e,b=[],U=null),_!==t&&(_=t,b=[],U=null)},startNewSession:async function(e,t,a){_=t,E=e,b=[],U=o},updateSessionInNotify:async function(e,t){let{sessionId:a,type:n,title:s,iconInfo:r}=t;switch(n){case"info":return await g.updateMeta(a,{title:s,iconInfo:r});case"deleted":return await g.removeId(a);case"update":{if(a===E)return;let t=await g.getLastEventId(a),n=await e(i.R.endpoints.getSession.initiate({sessionId:a,startEventId:t||void 0,type:"private"},{forceRefetch:!0})).unwrap();if(t)return await g.pushConfirmedEvents(a,n.events,t);return await g.updateSession(n,!0)}}}}},27846:(e,t,a)=>{"use strict";a.d(t,{A:()=>S});var i=a(75958),n=a(16834),s=a(12766),r=a(58220),o=a(93347),c=a(78085),l=a(37706),u=a(59413),d=a(88672),w=a(5685),p=a(40757),f=a(21731),m=a(34352),v=a(55496),y=a(14132);function S(){let e=(0,d.wA)(),t=(0,l.rd)(),a=(0,i.w)(async e=>{t.push(c.bw.login.withParams({redirectUrl:e||c.bw.app.root()}))}),S=(0,i.w)(async()=>{let e=(0,p.Pq)(w.M_.getState().auth.userInfo);e.isActive?t.push(c.bw.app.root()):(e.isLogin,t.push(c.bw.invitations.root))}),g=(0,i.w)(async function(e){let{redirectUrl:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=new URL("".concat(s.a.rpcServerUrl,"/api/user/oauth2_authorize")),i=new URL(window.location.href);i.pathname=c.bw.authLanding.root,i.searchParams.set("redirectUrl",t||c.bw.app.root()),a.searchParams.set("type",e),a.searchParams.set("redirect_url",i.toString()),window.location.href=a.toString()}),h=(0,i.w)(async()=>{e(p.RJ.actions.updateUserInfo(null)),(0,r.qc)(),u.A.remove(n.eu.loginSuccess),localStorage.removeItem(n.d5.UserInfo),localStorage.removeItem(n.d5.freeQuotes),await (0,y.ri)(),u.A.remove("session_id"),location.href="".concat(c.bw.root,"?index=1")}),I=(0,i.w)(async t=>{let{verificationCode:a}=t;e(p.RJ.actions.updateUserInfo(null)),(0,r.qc)(),u.A.remove(n.eu.loginSuccess),localStorage.removeItem(n.d5.UserInfo),localStorage.removeItem(n.d5.freeQuotes),await (0,y.mz)({verificationCode:a}),u.A.remove("session_id"),location.href="".concat(c.bw.root,"?index=1")}),b=(0,i.w)(async e=>{let{action:t}=e;try{await (0,y.fy)({action:t})}catch(e){(0,m.oR)({variant:"error",title:(0,v._I)(e)})}}),_=(0,i.w)(async()=>{let t=await o.F.UserService.getFreeQuota({});e(p.RJ.actions.setFreeQuotes(t))}),E=(0,i.w)(async()=>{e(p.RJ.actions.setAuthLoading(!0));let t=await o.F.UserService.userInfo({}).finally(()=>{e(p.RJ.actions.setAuthLoading(!1)),_()});e(p.RJ.actions.setUserInfo(t))}),U=(0,i.w)(async t=>{let a=localStorage.getItem(n.d5.UserInfo),i=localStorage.getItem(n.d5.freeQuotes);e(p.RJ.actions.setUserInfo(a?JSON.parse(a):null)),e(p.RJ.actions.setFreeQuotes(i?JSON.parse(i):null)),t&&await E()});return{handleLogout:h,handleLogoff:I,gotoLogin:a,fetchEmailVerifyCodeWithAuth:b,fetchUserInfo:E,fetchFreeUserQuote:_,initAuth:U,handleCheckStart:S,handleLogin:g,modifyUserInfo:(0,i.w)(async function(t){e(p.RJ.actions.setModifying(!0));try{e(p.RJ.actions.updateUserInfo({nickname:t.name})),await o.F.UserService.updateUserProfile({newNickname:t.name})}finally{e(p.RJ.actions.setModifying(!1))}}),modifyUserAvatar:(0,i.w)(async function(t){e(p.RJ.actions.setAvatarUploading(!0));try{var a;let i=await (0,f.pJ)(t.file,128),n=await (0,f.zM)(i),s=(null===(a=n.split(";")[1])||void 0===a?void 0:a.replace(/^base64,/,""))||"";await o.F.UserService.updateUserProfile({newAvatar:{fileName:t.file.name,mimeType:t.file.type,data:s}}),e(p.RJ.actions.updateUserInfo({avatar:n}))}catch(e){(0,m.oR)({variant:"error",title:(0,v._I)(e)})}finally{e(p.RJ.actions.setAvatarUploading(!1))}})}}},14132:(e,t,a)=>{"use strict";a.d(t,{pz:()=>w,l4:()=>c,mz:()=>p,ri:()=>m,zo:()=>l,vy:()=>v,pu:()=>d,fy:()=>f,LB:()=>u});var i=a(12766),n=a(20948),s=a(18952),r=a(24990);async function o(e,t,a){let o=new URL(e,i.a.rpcServerUrl);"GET"===t&&Object.entries(a).forEach(e=>{let[t,a]=e;(0,n.A)(a)||o.searchParams.set(t,a)});let c=new Headers;await (0,r.q)(c,{setApiKey:!0}),"POST"===t&&c.set("Content-Type","application/json");let l=await fetch(o.toString(),{method:t,mode:"cors",credentials:"include",headers:c,body:"POST"===t?JSON.stringify((0,s.T)("server",a)):void 0});if(!l.ok)throw Error("Network error: ".concat(l.status," - ").concat(l.statusText));let u=l.headers.get("Content-Type");if(!(null==u?void 0:u.includes("application/json")))throw Error("Not a json response");let d=await l.json();if(0!==d.code)throw Error(d.msg);return(0,s.T)("client",d)}function c(e){return o("/api/user/login_by_email","POST",e)}function l(e){return o("/api/user/register_by_email","POST",e)}function u(e){return o("/api/user/send_email_verify_code_with_captcha","POST",e)}function d(e){return o("/api/user/reset_password_with_captcha","POST",e)}function w(e){return o("/api/user/list_email_registered","POST",e)}function p(e){return o("/api/user/logoff","POST",e)}function f(e){return o("/api/user/send_email_verify_code_with_auth","POST",e)}function m(){return o("/api/user/logout","GET",{})}function v(e){return o("/api/user/reset_password_with_auth","POST",e)}}}]);